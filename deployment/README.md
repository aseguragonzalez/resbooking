# Deployment Configuration

This folder contains Apache configuration files and setup scripts for deploying
the Resbooking application.

## Structure

- `apache/sites-available/` - Apache virtual host configurations for each webapp
  - `dashboard.conf` - Main Dashboard webapp (port 8080)
  - `coverage.conf` - PHPUnit coverage reports (port 9000)
- `apache/ports.conf` - Apache ports configuration
- `scripts/` - Setup and management scripts

## Webapps

### Dashboard

- **Port**: 8080
- **URL**: <http://localhost:8080>
- **Document Root**: `src/Infrastructure/Ports/Dashboard`
- **Type**: PHP application with routing
- **Configuration**: Uses `.htaccess` for URL rewriting

### Coverage

- **Port**: 9000
- **URL**: <http://localhost:9000>
- **Document Root**: `coverage/` (generated by PHPUnit)
- **Type**: Static HTML files
- **Note**: Only available after running `make test`

## Adding a New Webapp

1. Create the webapp in `src/Infrastructure/Ports/<WebappName>/` (if PHP app)
   OR configure the document root appropriately
2. Copy `apache/sites-available/README.md` template
3. Create `apache/sites-available/<webapp-name>.conf` with appropriate settings:
   - Choose a port (8080, 9000, or add new port to `ports.conf`)
   - Set `DocumentRoot` to the webapp's directory
   - Configure PHP handler if needed (see Dashboard example)
   - Configure static file serving if needed (see Coverage example)
4. For PHP apps: Create `src/Infrastructure/Ports/<WebappName>/.htaccess` (copy
from `src/Infrastructure/Ports/Dashboard/.htaccess`)
5. Update `deployment/apache/ports.conf` if using a new port
6. Run `make enable-site WEBAPP=<webapp-name>` or restart devcontainer

## Development (DevContainer)

Apache is automatically configured when the devcontainer starts via
`postCreateCommand` in `.devcontainer/devcontainer.json`.

Both Dashboard and Coverage sites are enabled by default.

### First Time Setup

When you first open the project in a devcontainer:

1. The container will automatically run `deployment/scripts/setup-apache.sh`
2. Apache will be configured and started
3. Both webapps will be accessible immediately

### Manual Apache Management

If you need to manage Apache manually:

```bash
# Restart Apache
make apache-restart

# Reload Apache configuration (graceful)
make apache-reload

# View Apache logs
make apache-logs

# Enable a specific webapp
make enable-site WEBAPP=dashboard

# Disable a specific webapp
make disable-site WEBAPP=coverage
```

## Production Deployment

1. Copy `deployment/apache/ports.conf` to `/etc/apache2/ports.conf` (adjust
 ports as needed)
2. Copy site configs from `deployment/apache/sites-available/` to `/etc/apache2/sites-available/`
3. Run `deployment/scripts/setup-apache.sh` (or adapt for your environment)
4. Enable sites: `a2ensite <webapp-name>.conf`
5. Reload Apache: `apache2ctl graceful`

**Note**: In production, you may want to:

- Disable the coverage site or restrict access
- Use standard ports (80/443) instead of 8080/9000
- Configure SSL/TLS certificates
- Set up proper authentication for coverage reports
- Adjust security headers and other Apache directives

## Managing Sites

- Enable: `make enable-site WEBAPP=dashboard` or `make enable-site WEBAPP=coverage`
- Disable: `make disable-site WEBAPP=dashboard` or `make disable-site WEBAPP=coverage`
- View logs: `make apache-logs`
- Restart: `make apache-restart`
- Reload: `make apache-reload`

## Accessing Webapps

- **Dashboard**: <http://localhost:8080>
- **Coverage**: <http://localhost:9000> (requires running `make test` first)

## Troubleshooting

### Apache not starting

- Check if ports 8080 and 9000 are available
- Verify Apache configuration: `apache2ctl configtest`
- Check Apache error logs: `tail -f /var/log/apache2/error.log`

### Webapp not accessible

- Verify the site is enabled: `a2ensite <webapp-name>.conf`
- Check if Apache is running: `apache2ctl status`
- Verify port forwarding in devcontainer settings

### Static files not loading

- Check `.htaccess` file exists in the webapp directory
- Verify `mod_rewrite` is enabled: `a2enmod rewrite`
- Check file permissions

### PHP errors

- Verify PHP extensions are installed (pdo_mysql, xdebug)
- Check PHP error logs: `tail -f /var/log/apache2/error.log`
- Verify PHP handler is configured in virtual host
